---
alwaysApply: true
description: "Regras crÃ­ticas do projeto MarcBuddy - Estado atual: Supabase, schemas separados, mclients no schema mclients, proteÃ§Ãµes crÃ­ticas"
filePattern: "*"
---

/**
 * ====================================================================
 * REGRAS CRÃTICAS DO PROJETO MARCBUDDY - ESTADO ATUAL
 * ====================================================================
 * 
 * Este arquivo contÃ©m as regras mais importantes do projeto.
 * SEMPRE leia este arquivo antes de fazer modificaÃ§Ãµes crÃ­ticas.
 * 
 * Ãšltima atualizaÃ§Ã£o: Dezembro 2024
 */

/**
 * ====================================================================
 * 1. ARQUITETURA DO BANCO DE DADOS - SUPABASE
 * ====================================================================
 * 
 * O projeto usa Supabase PostgreSQL como banco de dados principal.
 * 
 * ESTRUTURA DE SCHEMAS:
 * - Schema `public`: Tabelas da plataforma (users, subscriptions, plans, payment_methods, coupons, coupon_usage)
 * - Schema `mclients`: Todas as 12 tabelas da ferramenta mclients
 * 
 * TABELAS NO SCHEMA MCLIENTS:
 * - mclients_clients
 * - mclients_follow_through_models
 * - mclients_follow_throughs
 * - mclients_demands
 * - mclients_payments
 * - mclients_documents
 * - mclients_services
 * - mclients_tasks
 * - mclients_pending_approvals
 * - mclients_time_entries
 * - mclients_activities
 * - mclients_briefing_submissions
 * 
 * IMPORTANTE:
 * - SEMPRE use `mclients.` ao referenciar tabelas do schema mclients nas queries
 * - SEMPRE use `public.` ao referenciar tabelas do schema public (ou omita se for o padrÃ£o)
 * - Foreign keys funcionam entre schemas diferentes
 * - Realtime estÃ¡ configurado para ambos os schemas
 * 
 * CONEXÃƒO:
 * - Connection string: `SUPABASE_DB_CONNECTION_STRING` no .env
 * - URL: `https://umydjofqoknbggwtwtqv.supabase.co`
 * - Todas as queries devem usar o schema correto
 */

/**
 * ====================================================================
 * 2. PROTEÃ‡Ã•ES CRÃTICAS - MCLIENTS CONTROLLER
 * ====================================================================
 * 
 * O arquivo `backend/src/controllers/mclients.controller.js` contÃ©m lÃ³gica crÃ­tica.
 * Veja `backend/src/controllers/PROTECAO_MCLIENTS.md` para detalhes completos.
 * 
 * REGRAS CRÃTICAS QUE NÃƒO DEVEM SER MODIFICADAS:
 * 
 * 1. FunÃ§Ã£o `saveFollowThrough`:
 *    - DEVE sempre salvar o `briefing_url` (pode ser null, mas DEVE ser salvo)
 *    - O INSERT usa `ON CONFLICT (external_id)` e DEVE retornar `id, external_id, briefing_url`
 *    - NÃƒO remover o campo briefing_url do INSERT
 * 
 * 2. FunÃ§Ã£o `saveMClientsData`:
 *    - DEVE resolver `modelId` e `clientId` antes de salvar
 *    - DEVE permitir `clientId` null para novos clientes (isNewClient=true)
 *    - DEVE filtrar `pendingApprovals` com `followThroughId` invÃ¡lido para evitar FK violations
 *    - NÃƒO fazer ROLLBACK se cliente nÃ£o for encontrado para novos clientes
 * 
 * 3. FunÃ§Ã£o `getFollowThroughByToken`:
 *    - DEVE buscar primeiro apenas pelo token
 *    - DEVE tentar buscar com username tambÃ©m (fallback)
 *    - NÃƒO modificar a lÃ³gica de busca
 * 
 * 4. FunÃ§Ã£o `submitBriefing`:
 *    - NÃƒO criar cliente automaticamente quando o formulÃ¡rio Ã© enviado
 *    - O cliente sÃ³ deve ser criado quando o usuÃ¡rio aprovar a aprovaÃ§Ã£o pendente
 *    - Apenas criar aprovaÃ§Ã£o pendente com os dados do cliente
 */

/**
 * ====================================================================
 * 3. FLUXO DE CRIAÃ‡ÃƒO DE CLIENTES - MCLIENTS
 * ====================================================================
 * 
 * IMPORTANTE: Clientes NÃƒO sÃ£o criados automaticamente quando o formulÃ¡rio Ã© enviado.
 * 
 * FLUXO CORRETO:
 * 1. UsuÃ¡rio preenche formulÃ¡rio de briefing â†’ apenas cria aprovaÃ§Ã£o pendente
 * 2. Admin vÃª aprovaÃ§Ã£o pendente â†’ pode ver respostas completas
 * 3. Admin aprova â†’ cliente e demanda sÃ£o criados no banco
 * 4. Admin rejeita â†’ aprovaÃ§Ã£o marcada como rejeitada, cliente nÃ£o Ã© criado
 * 
 * NUNCA:
 * - Criar cliente automaticamente no `submitBriefing`
 * - Criar cliente antes da aprovaÃ§Ã£o
 * - Modificar a lÃ³gica para criar cliente automaticamente
 */

/**
 * ====================================================================
 * 4. EXCLUSÃƒO DE DADOS
 * ====================================================================
 * 
 * EXCLUSÃƒO DE CLIENTES:
 * - Rota: `DELETE /api/mclients/clients/:id`
 * - FunÃ§Ã£o: `deleteClient` em `mclients.controller.js`
 * - Aceita ID numÃ©rico (do banco) ou UUID (converte automaticamente)
 * - CASCADE remove demandas, pagamentos, documentos relacionados
 * 
 * EXCLUSÃƒO DE FOLLOW-THROUGHS:
 * - Rota: `DELETE /api/mclients/follow-throughs/:id`
 * - Usa `external_id` (UUID) para identificar
 * 
 * EXCLUSÃƒO DE MODELOS:
 * - Rota: `DELETE /api/mclients/models/:id`
 * - Usa `external_id` (UUID) para identificar
 */

/**
 * ====================================================================
 * 5. REGRA DE ÃCONES
 * ====================================================================
 * 
 * SEMPRE utilize Ã­cones de bibliotecas profissionais ao invÃ©s de emojis de texto.
 * 
 * Bibliotecas preferidas (nessa ordem):
 * 1. Lucide React (lucide-react) - Moderna, leve, consistente
 * 2. Heroicons React (@heroicons/react) - Oficial do Tailwind
 * 3. React Icons (react-icons) - ColeÃ§Ã£o ampla de Ã­cones
 * 
 * NUNCA use emojis (ðŸ’³, ðŸ“„, ðŸŒ, âœ…, etc.) em elementos de interface.
 * Use Ã­cones SVG das bibliotecas acima.
 */

/**
 * ====================================================================
 * 6. REGRA DE DIRETÃ“RIOS E COMANDOS NPM
 * ====================================================================
 * 
 * SEMPRE verifique o diretÃ³rio atual antes de executar comandos npm.
 * 
 * Estrutura do projeto:
 * - `/` - Raiz do projeto
 * - `/frontend` - DiretÃ³rio do frontend (React/Vite)
 * - `/backend` - DiretÃ³rio do backend (Node.js/Express)
 * 
 * IMPORTANTE: No PowerShell, use `;` ao invÃ©s de `&&` para encadear comandos.
 * - âœ… CORRETO: `cd backend; npm run dev`
 * - âŒ ERRADO: `cd backend && npm run dev` (nÃ£o funciona no PowerShell)
 */

/**
 * ====================================================================
 * 7. REGRA DE AUTENTICAÃ‡ÃƒO PARA TESTES
 * ====================================================================
 * 
 * CRÃTICO: SEMPRE FAÃ‡A LOGIN PRIMEIRO AO TESTAR FERRAMENTAS OU RECURSOS PROTEGIDOS
 * 
 * Credenciais para login (CONTA ADMIN):
 * - Email: `josmarcdesign@gmail.com`
 * - Senha: `12345`
 * 
 * Esta conta tem permissÃµes de admin e acesso a todas as ferramentas.
 * SEMPRE faÃ§a login antes de testar qualquer funcionalidade protegida.
 */

/**
 * ====================================================================
 * 8. REGRA DE GERENCIAMENTO DE SERVIDORES
 * ====================================================================
 * 
 * SEMPRE verifique se os servidores backend e frontend estÃ£o rodando.
 * 
 * Comandos para iniciar:
 * - Backend: `cd backend; npm run dev` (porta 3001)
 * - Frontend: `cd frontend; npm run dev` (porta 3000)
 * 
 * IMPORTANTE: No PowerShell, use `;` ao invÃ©s de `&&`.
 * Para comandos em background, use caminho completo ou combine cd com comando usando `;`.
 */

/**
 * ====================================================================
 * 9. SUPABASE REALTIME
 * ====================================================================
 * 
 * O projeto usa Supabase Realtime para monitorar mudanÃ§as no banco de dados.
 * 
 * CONFIGURAÃ‡ÃƒO:
 * - Todas as tabelas mclients estÃ£o na publicaÃ§Ã£o `supabase_realtime`
 * - Schema: `mclients` (nÃ£o `public`)
 * - Canais: `realtime:mclients:mclients_clients`, etc.
 * 
 * HOOKS:
 * - `useRealtime(tableName, filter)` - Hook para escutar tabelas
 * - `useRealtimeTable(tableName, userId)` - Hook simplificado
 * 
 * COMPONENTES:
 * - `RealtimeConsole` - Componente para exibir eventos em tempo real
 * 
 * IMPORTANTE: Ao usar Realtime, especifique o schema correto:
 * - Para tabelas mclients: usar schema `mclients`
 * - Para tabelas public: usar schema `public` (padrÃ£o)
 */

/**
 * ====================================================================
 * 10. ESTRUTURA DE DADOS - MCLIENTS
 * ====================================================================
 * 
 * DADOS SÃƒO SALVOS NO BANCO DE DADOS (NÃƒO em arquivos JSON):
 * - Todos os dados sÃ£o salvos no Supabase PostgreSQL
 * - Schema `mclients` para dados da ferramenta
 * - Schema `public` para dados da plataforma
 * 
 * SINCRONIZAÃ‡ÃƒO:
 * - Frontend usa `useMClientsData` hook para gerenciar dados
 * - Backend usa queries diretas ao PostgreSQL
 * - IDs sÃ£o sincronizados via `external_id` (UUID) para follow-throughs e modelos
 * 
 * NÃƒO EXISTE MAIS:
 * - Pasta `backend/data/mclients/` (foi removida)
 * - Arquivos `data.json` locais
 * - Tabela `mclients_data` JSONB (foi substituÃ­da por tabelas relacionais)
 */

/**
 * ====================================================================
 * 11. ROW LEVEL SECURITY (RLS)
 * ====================================================================
 * 
 * RLS estÃ¡ habilitado em todas as tabelas pÃºblicas.
 * 
 * POLÃTICAS:
 * - `service_role`: Acesso total (backend)
 * - `authenticated`: Acesso aos prÃ³prios dados (user_id)
 * - `anon`: Leitura pÃºblica para planos, payment_methods, coupons
 * 
 * IMPORTANTE:
 * - Backend usa `service_role` (bypass RLS)
 * - Frontend usa `authenticated` (respeita RLS)
 * - Queries devem sempre incluir `user_id` para filtragem
 */

/**
 * ====================================================================
 * 12. MIGRAÃ‡Ã•ES DO BANCO DE DADOS
 * ====================================================================
 * 
 * MIGRAÃ‡Ã•ES IMPORTANTES:
 * - V11: Tabela mclients_data (JSONB) - OBSOLETA, nÃ£o usar mais
 * - V12: Tabelas relacionais mclients_* (schema public) - OBSOLETA
 * - V13: AdiÃ§Ã£o de external_id (UUID) para sincronizaÃ§Ã£o
 * - V14: Habilitar RLS em todas as tabelas
 * - V15: Configurar Realtime para tabelas mclients
 * - V16: Adicionar users ao Realtime
 * - V17: Criar schema mclients e mover tabelas
 * 
 * EXECUTAR MIGRAÃ‡Ã•ES:
 * - `npm run migrate:v17` - Executar migraÃ§Ã£o especÃ­fica
 * - `npm run migrate:all` - Executar todas as migraÃ§Ãµes
 * 
 * IMPORTANTE: Sempre execute migraÃ§Ãµes em ordem sequencial.
 */

/**
 * ====================================================================
 * 13. ARQUIVOS SENSÃVEIS
 * ====================================================================
 * 
 * Sempre tenha atenÃ§Ã£o redobrada ao editar cÃ³digos sensÃ­veis de:
 * - SeguranÃ§a (auth, token, senha, password)
 * - AutenticaÃ§Ã£o e autorizaÃ§Ã£o
 * - OperaÃ§Ãµes de banco de dados (database, db, query)
 * - LÃ³gica central do projeto
 * 
 * Antes de alterar, revise os impactos, faÃ§a backups e teste cuidadosamente.
 */

module.exports = {
  meta: {
    type: "problem",
    docs: {
      description: "Regras crÃ­ticas do projeto MarcBuddy - Supabase, schemas separados, proteÃ§Ãµes mclients",
      category: "Best Practices",
      recommended: true,
    },
    schema: [],
    messages: {
      attention: "Revise cuidadosamente ao alterar cÃ³digos de seguranÃ§a, autenticaÃ§Ã£o, autorizaÃ§Ã£o, operaÃ§Ãµes de banco de dados ou lÃ³gica central.",
    },
  },

  create(context) {
    const sensitivePatterns = [
      /auth/i,
      /token/i,
      /senha|password/i,
      /database|db|query/i,
      /ban|unban/i,
      /subscription/i,
      /plan/i,
      /user.*role/i,
      /validate/i,
      /mclients/i,
      /briefing/i,
      /follow.*through/i,
    ];

    function isSensitive(filename) {
      return sensitivePatterns.some((pattern) => pattern.test(filename));
    }

    return {
      Program(node) {
        const filename = context.getFilename();

        if (isSensitive(filename)) {
          context.report({
            node,
            messageId: "attention",
          });
        }
      },
    };
  },
};
